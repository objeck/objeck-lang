use Collection, Web.HTTP, System.IO.Filesystem;

class Test {
	function : Main(args : String[]) ~ Nil {
		if(args->Size() = 1) {
			token := args[0];

			client := SecureWebSocket->New(Url->New("wss://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-12-17"));
			client->AddHeader("Authorization", "Bearer {$token}");
			client->AddHeader("OpenAI-Beta", "realtime=v1");

			if(client->Connect()) {
				"Connected..."->PrintLine();
				client->ReadTextSocket()->PrintLine();

				send_msg := "{
					\"type\": \"conversation.item.create\",
					\"item\": {
						\"type\": \"message\",
						\"role\": \"user\",
						\"content\": [
							{				
								\"type\": \"input_text\",
								\"text\": \"What Prince album sold the most copies?\"
							}
						]
					}
				}";
				"send_msg=\"{$send_msg}\""->PrintLine();
				client->WriteTextSocket(send_msg);
				
				recv_msg := client->ReadTextSocket();
				if(recv_msg <> Nil) {
					"recv_msg=\"{$recv_msg}\""->PrintLine();
				}
				else {
					status_code := client->GetLastStatus();
					"closed: code={$status_code}"->PrintLine();
				};
				
				client->CloseSocket();
			};
		};
	}
}
